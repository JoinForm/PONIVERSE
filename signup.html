<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PONIVERSE – 회원가입</title>

  <link rel="stylesheet" href="css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="image/icon/favicon.ico" />
  <style>
    .signup-page .hero { padding: 120px 16px 48px; }
    @media (max-width: 600px){ .signup-page .hero { padding: 96px 12px 36px; } }
  </style>
</head>

<body class="dark-grad signup-page">
  <header class="hero">
    <h1 class="title-animate">PONIVERSE</h1>
    <p class="subtitle">회원가입</p>
  </header>

  <section style="display:flex;justify-content:center;margin:0 auto 80px; padding:0 16px;">
    <div class="modal-dialog" style="max-width:620px;width:min(92vw,620px);">
      <div class="modal-header">
        <h2>회원가입</h2>
      </div>

      <form id="signupForm" class="modal-body">
        <label>이름(아이디)
          <input type="text" name="username" required placeholder="아이디를 입력하세요" />
        </label>

        <label>성별
          <select name="gender" required>
            <option value="" selected disabled>선택</option>
            <option value="남">남</option>
            <option value="여">여</option>
          </select>
        </label>

        <label>비밀번호
          <input type="password" name="password" required minlength="6" placeholder="비밀번호 (6자 이상)" />
        </label>

        <label>비밀번호 확인
          <input type="password" name="passwordConfirm" required minlength="6" placeholder="비밀번호 확인" />
        </label>

        <label>나이(년도)
          <select name="birthYear" required>
            <option value="" selected disabled>선택</option>
          </select>
        </label>

        <label>연락처
          <input type="tel" name="phone" required placeholder="예: 010-1234-5678" inputmode="numeric" />
        </label>

        <label>지역
          <input type="text" name="region" required placeholder="예: 포항 해도동" />
        </label>

        <div class="modal-actions">
          <button type="submit" class="btn primary">가입하기</button>
          <button type="button" class="btn ghost" id="cancelBtn">취소</button>
        </div>
      </form>
    </div>
  </section>

  <script src="js/signup-year.js" defer></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, updateProfile,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfs8ZN-2ANX0lYvT_WVcOMXRkNB5usuRw",
      authDomain: "poniverse-3c351.firebaseapp.com",
      projectId: "poniverse-3c351",
      storageBucket: "poniverse-3c351.appspot.com",
      messagingSenderId: "608146456053",
      appId: "1:608146456053:web:711de65e21a2e54a6574bc",
      measurementId: "G-GFRG38YKVW"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // 연락처 자동 하이픈
    function normalizePhone(r){ return (r||"").replace(/\D/g,""); }
    function formatPhone(r){
      const d=normalizePhone(r);
      if(d.startsWith("02")) return d.replace(/^(\d{0,2})(\d{0,4})(\d{0,4}).*/,(_,a,b,c)=>[a,b,c].filter(Boolean).join("-"));
      return d.replace(/^(\d{0,3})(\d{0,4})(\d{0,4}).*/,(_,a,b,c)=>[a,b,c].filter(Boolean).join("-"));
    }
    const phoneInput=document.querySelector('input[name="phone"]');
    if(phoneInput) phoneInput.addEventListener("input",()=>phoneInput.value=formatPhone(phoneInput.value));

    function makeFakeEmail(name,phone){
      const clean=name.replace(/\s+/g,"").replace(/[^ㄱ-ㅎ가-힣a-zA-Z0-9]/g,"");
      const digits=normalizePhone(phone);
      return `${clean}.${digits}@poniverse.kr`;
    }

    document.getElementById("cancelBtn").addEventListener("click",()=>location.href="index.html");

    const form=document.getElementById("signupForm");
    form.addEventListener("submit",async e=>{
      e.preventDefault();
      const name=form.username.value.trim();
      const gender=form.gender.value;
      const pw=form.password.value;
      const pw2=form.passwordConfirm.value;
      const birth=form.birthYear.value;
      const region=form.region.value.trim();
      const phoneRaw=form.phone.value.trim();
      const phone=normalizePhone(phoneRaw);

      if(!name||!gender||!pw||!pw2||!birth||!region||!phone){alert("모든 항목을 입력하세요.");return;}
      if(pw!==pw2){alert("비밀번호가 일치하지 않습니다.");return;}
      if(!(phone.length===10||phone.length===11)){alert("연락처는 10~11자리로 입력하세요.");return;}

      const fakeEmail=makeFakeEmail(name,phone);
      const cred=await createUserWithEmailAndPassword(auth,fakeEmail,pw);
      await updateProfile(cred.user,{displayName:name});
      await setDoc(doc(db,"users",cred.user.uid),{
        uid:cred.user.uid,name,email:fakeEmail,gender,birthYear:birth,region,phone,
        role:"member",
        groups:{camp:false,board:false,sport:false,free:false},
        attendance:{camp:false,board:false,sport:false,free:false},
        createdAt:serverTimestamp(),updatedAt:serverTimestamp()
      });

      // ✅ 회원가입 완료 후 home 페이지로 이동
      alert("회원가입이 완료되었습니다!\n이제 홈으로 이동합니다.");
      location.href = "home.html";
    });
  </script>
</body>
</html>
