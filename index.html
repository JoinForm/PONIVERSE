<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PONIVERSE</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="image/icon/favicon.ico" />
</head>

<body class="dark-grad">
  <header class="hero">
    <h1 class="title-animate" id="titleText">PONIVERSE</h1>
    <p class="subtitle">í¬ë‹ˆë²„ìŠ¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
    <p class="mini-counts">
      ìº í•‘ <span id="c1">0</span><span id="d1">/20</span> Â·
      ë³´ë“œê²Œì„ <span id="c2">0</span><span id="d2">/20</span> Â·
      ìš´ë™ <span id="c3">0</span><span id="d3">/20</span>
    </p>

    <!-- ë§í¬í˜• ë²„íŠ¼ -->
    <div class="btn-row">
      <a href="signup.html" class="btn">íšŒì›ê°€ì…</a>
      <a href="login.html"  class="btn ghost">ë¡œê·¸ì¸</a>
    </div>
  </header>

  <!-- ë¡œê·¸ì¸ í›„ ì•ˆë‚´ ë°°ë„ˆ -->
  <div id="groupsNotice" class="groups-warning" aria-hidden="true"></div>

  <!-- ë¡œê·¸ì¸ í›„ ëª¨ì„ ì¹´ë“œ ì»¨í…Œì´ë„ˆ -->
  <section id="groups" class="groups" aria-hidden="true"></section>

  <!-- ê°¤ëŸ¬ë¦¬ -->
  <section class="gallery" id="gallery"></section>

  <!-- í˜ì´ì§€ í•˜ë‹¨ ìš°ì¸¡ ë²„íŠ¼ (ì´ˆê¸° ìˆ¨ê¹€) -->
  <div class="page-actions" aria-hidden="true">
    <button id="withdrawBtn" class="withdraw-btn">íšŒì› íƒˆí‡´</button>
  </div>

  <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
  <div id="imgModal" class="modal" hidden>
    <div class="modal-body">
      <button class="modal-close" data-close="imgModal" aria-label="ë‹«ê¸°">Ã—</button>
      <img id="modalImg" src="" alt="" />
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast" aria-live="polite"></div>

  <!-- ê¸°ì¡´ ë™ì‘ ìŠ¤í¬ë¦½íŠ¸ (ê°¤ëŸ¬ë¦¬/ê·¸ë£¹/ê°€ë“œ ë“±) -->
  <script type="module" src="js/app.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, serverTimestamp,
      collection, query, where, getCountFromServer
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ... firebaseConfig / app / auth / db / setPersistence (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)

    const LIMIT = 20;
    const c1 = document.getElementById("c1"); // ìº í•‘
    const c2 = document.getElementById("c2"); // ë³´ë“œê²Œì„
    const c3 = document.getElementById("c3"); // ìš´ë™

    async function refreshCounts(){
      try{
        const usersRef = collection(getFirestore(), "users");
        const [camp, board, sport] = await Promise.all([
          getCountFromServer(query(usersRef, where("groups.camping",   "==", true))),
          getCountFromServer(query(usersRef, where("groups.boardgame", "==", true))),
          getCountFromServer(query(usersRef, where("groups.sports",    "==", true))),
        ]).then(res => res.map(s => s.data().count || 0));

        if(c1){ c1.textContent = String(Math.min(camp,  LIMIT));  c1.style.color = camp  >= LIMIT ? "#ff4d4d" : "#66d1ff"; }
        if(c2){ c2.textContent = String(Math.min(board, LIMIT));  c2.style.color = board >= LIMIT ? "#ff4d4d" : "#66d1ff"; }
        if(c3){ c3.textContent = String(Math.min(sport, LIMIT));  c3.style.color = sport >= LIMIT ? "#ff4d4d" : "#66d1ff"; }
      }catch(err){
        console.error("[refreshCounts]", err);
      }
    }
    window.refreshCounts = refreshCounts; // í•„ìš” ì‹œ ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥

    // âœ… âŠ í˜ì´ì§€ ë¡œë“œ ë•Œë§ˆë‹¤ (ìƒˆë¡œê³ ì¹¨/ì²« ì§„ì… í¬í•¨)
    document.addEventListener("DOMContentLoaded", refreshCounts);

    // âœ… â‹ ë¡œê·¸ì¸ ìƒíƒœ ë³€í•  ë•Œë„ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì§í›„)
    onAuthStateChanged(getAuth(), async (user)=>{
      // ... (ê¸°ì¡´ ì¸ì‚¿ë§/ë Œë” ì½”ë“œ ìœ ì§€)
      refreshCounts();
    });

    // âœ… âŒ íƒ­ì´ ë‹¤ì‹œ í™œì„±í™”ë˜ì—ˆì„ ë•Œ(ë’¤ë¡œê°€ê¸°/ë‹¤ë¥¸ íƒ­ ì „í™˜ í›„ ë³µê·€)
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "visible") refreshCounts();
    });

    // âœ… â ë„¤íŠ¸ì›Œí¬ê°€ ë‹¤ì‹œ ì—°ê²°ëì„ ë•Œ
    window.addEventListener("online", refreshCounts);

    // ğŸ” ëª¨ì„ í† ê¸€(DB ì—…ë°ì´íŠ¸ í›„ ì¹´ìš´íŠ¸ ì¬ì§‘ê³„)
    const map = { camp:"camping", board:"boardgame", sport:"sports", free:"free" };
    window.toggleGroup = async function(key, join){
      const user = getAuth().currentUser;
      if(!user) return;
      const field = map[key];
      if(!field) return;

      await updateDoc(doc(getFirestore(),"users",user.uid), {
        [`groups.${field}`]: !!join,
        updatedAt: serverTimestamp(),
      });

      // ì—…ë°ì´íŠ¸ í›„ ìµœì‹  ì¹´ìš´íŠ¸ ë°˜ì˜
      refreshCounts();
    };
    
  </script>





</body>
</html>
